<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>System inspekcji paczek (Realtime)</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-<2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO>" crossorigin="anonymous"></script>
    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:1rem; background:#f0f0f0; }
        .container { display:flex; justify-content: space-between; gap:10px; }

        .camera-panel {
            flex: 1;
            background:#fff;
            padding:10px;
            border-radius:8px;
            border:1px solid #ccc;
            text-align:center;
        }

        .camera-panel h2 { margin-top:0; }

        .latest-img { max-height: 50vh; max-width: 90%; border:4px solid #ccc; border-radius:8px; transition: border 0.2s; }

        .label-good { color: green; font-weight: bold; }
        .label-bad { color: red; font-weight: bold; }

        .img-border-good { border-color: green !important; }
        .img-border-bad { border-color: red !important; }

        .thumbs { display:flex; justify-content:center; flex-wrap:wrap; margin-top:10px; gap:10px; }
        .thumb { background:#fff; border:1px solid #ccc; border-radius:6px; padding:4px; width:120px; cursor:pointer; }
        .thumb img { width:100%; height:auto; max-height:100px; object-fit:contain; }

        .modal {
            display:none; position:fixed; z-index:999; left:0; top:0;
            width:100%; height:100%; background-color: rgba(0,0,0,0.85);
            justify-content:center; align-items:center; flex-direction:column;
        }

        .modal-content { max-width:90%; max-height:90%; position:relative; }
        .modal img { max-width:100%; max-height:80vh; border:3px solid #fff; border-radius:6px; }
        .modal-meta { margin-top:10px; color:#fff; font-size:1.1rem; text-align:center; }

        .modal-arrow { position:absolute; top:50%; transform:translateY(-50%); font-size:3rem; color:#fff; cursor:pointer; user-select:none; padding:0 10px; }
        .modal-arrow.left { left:0; }
        .modal-arrow.right { right:0; }

        .modal-close { position:absolute; top:10px; right:15px; font-size:2rem; color:#fff; cursor:pointer; user-select:none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="camera-panel" id="panel-X1">
            <h2>Kamera X1</h2>
            <label><input type="checkbox" id="sound-toggle-X1" checked> Sygnał dźwiękowy</label><br>
            <img id="latest-X1" class="latest-img" src="" alt="Brak zdjęcia">
            <div id="label-X1">—</div>
            <h3>Ostatnie 10 wadliwych paczek</h3>
            <div class="thumbs" id="thumbs-X1"></div>
        </div>

        <div class="camera-panel" id="panel-Y1">
            <h2>Kamera Y1</h2>
            <label><input type="checkbox" id="sound-toggle-Y1" checked> Sygnał dźwiękowy</label><br>
            <img id="latest-Y1" class="latest-img" src="" alt="Brak zdjęcia">
            <div id="label-Y1">—</div>
            <h3>Ostatnie 10 wadliwych paczek</h3>
            <div class="thumbs" id="thumbs-Y1"></div>
        </div>
    </div>

    <div class="modal" id="image-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">×</span>
            <span class="modal-arrow left" onclick="prevImage()">❮</span>
            <span class="modal-arrow right" onclick="nextImage()">❯</span>
            <img id="modal-img" src="" alt="">
            <div class="modal-meta" id="modal-meta"></div>
        </div>
    </div>

    <audio id="beep-sound" src="/static/beep.mp3" preload="auto"></audio>

    <script>
        const socket = io();
        const soundToggles = {
            X1: () => document.getElementById('sound-toggle-X1').checked,
            Y1: () => document.getElementById('sound-toggle-Y1').checked
        };
        const beepAudio = document.getElementById("beep-sound");
        const badImages = { X1: [], Y1: [] };
        let currentCam = '', currentIndex = 0;

        socket.on("new_image", (data) => {
            const cam = data.camera;
            const label = document.getElementById('label-' + cam);
            const img = document.getElementById('latest-' + cam);

            // aktualizacja głównego zdjęcia
            img.src = data.url + "?t=" + data.timestamp;
            label.textContent = data.category;

            label.classList.remove("label-good", "label-bad");
            img.classList.remove("img-border-good", "img-border-bad");

            if (data.category.toLowerCase() === "good") {
                label.classList.add("label-good");
                img.classList.add("img-border-good");
            } else {
                label.classList.add("label-bad");
                img.classList.add("img-border-bad");

                // dźwięk
                if (soundToggles[cam]()) {
                    beepAudio.currentTime = 0;
                    beepAudio.play().catch(() => {});
                }

                // miniatury
                badImages[cam].unshift(data);
                if (badImages[cam].length > 10) badImages[cam].pop();
                renderThumbs(cam);
            }
        });

        function renderThumbs(cam) {
            const thumbsEl = document.getElementById('thumbs-' + cam);
            thumbsEl.innerHTML = "";
            badImages[cam].forEach((item, index) => {
                const box = document.createElement("div");
                box.className = "thumb";
                box.onclick = () => showModal(cam, index);
                const img = document.createElement("img");
                img.src = item.url + "?t=" + item.timestamp;
                img.alt = item.filename;
                box.appendChild(img);
                thumbsEl.appendChild(box);
            });
        }

        function showModal(cam, index) {
            currentCam = cam;
            currentIndex = index;
            updateModal();
            document.getElementById("image-modal").style.display = "flex";
        }

        function updateModal() {
            const item = badImages[currentCam][currentIndex];
            if (!item) return;
            document.getElementById("modal-img").src = item.url + "?t=" + item.timestamp;
            document.getElementById("modal-meta").textContent = `${currentCam}: ${item.category} — ${item.filename}`;
        }

        function closeModal() {
            document.getElementById("image-modal").style.display = "none";
        }

        function prevImage() {
            currentIndex = (currentIndex - 1 + badImages[currentCam].length) % badImages[currentCam].length;
            updateModal();
        }

        function nextImage() {
            currentIndex = (currentIndex + 1) % badImages[currentCam].length;
            updateModal();
        }

        window.addEventListener("keydown", e => {
            if (e.key === "Escape") closeModal();
            if (e.key === "ArrowLeft") prevImage();
            if (e.key === "ArrowRight") nextImage();
        });

        document.getElementById("image-modal").addEventListener("click", e => {
            if (e.target === document.getElementById("image-modal")) closeModal();
        });

        // odblokowanie dźwięku
        document.body.addEventListener("click", function unlockAudioOnce() {
            beepAudio.play().catch(() => {});
            document.body.removeEventListener("click", unlockAudioOnce);
        });
    </script>
</body>
</html>
